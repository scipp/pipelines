parameters:
- name: image
  type: string
  default: ''

steps:
  - ${{ if contains(parameters.image, 'ubuntu') }}:
    - bash: |
        sudo apt-get install -y ccache
        echo "##vso[task.prependpath]/usr/lib/ccache"
      displayName: 'Install ccache Linux'
  - ${{ if contains(parameters.image, 'mac') }}:
    - bash: |
        brew install ccache
      displayName: 'Install ccache OSX'
  - bash: |
      # Set cache dir
      ccache --set-config=cache_dir="$(Pipeline.Workspace)/ccache"
      echo "##vso[task.setvariable variable=ccache_dir]$(Pipeline.Workspace)/ccache"
    displayName: 'Configure ccache'
  - task: Cache@2
    inputs:
      key: 'ccache | "$(Agent.OS)" | "$(Build.SourceVersion)"'
      restoreKeys: |
        ccache | "$(Agent.OS)" | "$(Build.SourceVersion)"
        ccache | "$(Agent.OS)"
      path: "$(CCACHE_DIR)"
    displayName: 'Process ccache'
  - bash: ccache --show-stats
    displayName: 'Report ccache statistics'
